---
binary_sensor:
  - platform: ping
    host: 8.8.8.8
    name: Online
    count: 1
    scan_interval: 300
# sensor:
#   - platform: scrape
#     resource: https://www.whoismyisp.org
#     select: ".isp"
#     name: "Internet Provider"
#     scan_interval: 60

sensor:
  - platform: rest
    name: nbn_location_home
    resource: https://places.nbnco.net.au/places/v2/details/LOC000018433654
    headers:
      Referer: https://www.nbnco.com.au/
    value_template: "{{ value_json.addressDetail.altReasonCode }}"
    scan_interval: 7200 # update the value every 2 hours
    json_attributes:
      - servingArea
      - addressDetail

  - platform: rest
    name: nbn_location_dadwork
    resource: https://places.nbnco.net.au/places/v2/details/LOC000107178217
    headers:
      Referer: https://www.nbnco.com.au/
    value_template: "{{ value_json.addressDetail.altReasonCode }}"
    scan_interval: 7200 # update the value every 2 hours
    json_attributes:
      - servingArea
      - addressDetail

  - platform: template
    sensors:
      nbn_status_home:
        friendly_name: "NBN Status"
        value_template: >-
          {% set alt_reason_code = states('sensor.nbn_location_home') %}
          {% if alt_reason_code == 'NULL_NA' %}
            No FTTP upgrade
          {% elif alt_reason_code == 'FTTP_NA' %}
            FTTP Upgrade coming soon
          {% elif alt_reason_code == 'FTTP_SA' %}
            FTTP Upgrade available
          {% else %}
            {% if alt_reason_code %}
              {{ alt_reason_code }} was returned
            {% else %}
              Error
            {% endif %}
          {% endif %}

# automation:
#   - alias: Notify of FTTP upgrade availability
#     description: ""
#     trigger:
#       – platform: state
#         entity_id:
#           – sensor.nbn_status_home
#     condition:
#       – condition: not
#         conditions:
#           – condition: state
#             entity_id: sensor.nbn_alt_reason_code
#             state: NULL_NA
#     action:
#       – service: notify.mobile_app_pixel_5
#         data:
#           title: NBN status change
#           message: >-
#             NBN status just changed from "{{ trigger.from_state.state }}" to "{{
#             trigger.to_state.state }}"
#     mode: single
